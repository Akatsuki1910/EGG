まずはVPCを構成するプロジェクト、ネットワーク、サブネットを見ていきます
プロジェクトはGoogle Cloudのインフラリソースを管理する中核的オブジェクトです
プロジェクトによってオブジェクトとサービスが課金に紐づけられます
プロジェクトにはネットワーク全体が収められます
各プロジェクトにはデフォルトで５つのネットワークが割り当てられます
追加の割り当てはCloud Consoleで簡単にリクエストできます
プロジェクト間でのネットワーク共有やネットワークのピアリングも可能です
詳細は「Architecting with GCE」コースシリーズで後ほど説明します
VPCネットワークにIP範囲はなく、ネットワーク内の個々のIPアドレスとサービスで構成されます
Google Cloudのネットワークは、前に紹介した世界中の利用可能なリージョンにまたがっています
そのため１つのネットワークを作成すれば、アジア、欧州、南北アメリカを含む世界中に同時に存在することになります
ネットワーク内ではリージョンのサブネットでリソースを分離できます
前述のとおり、ネットワークの種類にはデフォルト、自動、カスタムがあります
これらの種類を詳しく見ていきましょう
どのプロジェクトにも、サブネットとファイアウォールが設定されたデフォルトVPCネットワークが提供されます
具体的には、重複しないCIDRブロックとファイアウォールルールを使用して各リージョンにサブネットが割り当てられます
ファイアウォールルールは、任意の場所からのICMP、RDP、SSHの内向きトラフィックと、デフォルトネットワーク内からの内向きトラフィックを全プロトコルとポートに対して許可します
自動モードネットワークでは、各リージョン内に１つのサブネットが自動的に作成されます
デフォルトネットワークは実際には自動モードです
自動作成されるサブネットでは、一連の事前定義されたIP範囲が使用されます
デフォルトのマスクは“/20”ですが、“/16”まで拡張できます
これらのサブネットはすべて、10.128.0.0/9 CIDRブロック内に収まります
つまり、新しいリージョンが使用可能になると、このブロックのIP範囲を使った新しいサブネットが自動的に追加されます
カスタムネットワークモードでは、サブネットは自動的に作成されません
この種類のネットワークでは、サブネットとIP範囲を完全に制御できます
どのサブネットをどのリージョンに、どのIP範囲で作成するかを管理者が決定します
ただし、同一ネットワークのサブネット間でIP範囲を重複させることはできません
自動モードネットワークをカスタムモードに変換して、カスタムモードならではの管理上の利点を利用することもできます
ただし、変換は一方向です
カスタムモードネットワークを自動モードに変換することはできません
自動モードネットワークの考慮事項を慎重に検討し、どちらの種類がニーズを満たすのかを判断してください
これは、５つのネットワークが含まれるプロジェクトの例です
右に示すようにすべてのネットワークは世界中の複数のリージョンにまたがっています
各ネットワークには個別の仮想マシンA、B、C、Dが含まれます
AとBは同じネットワーク１の中に配置されています
そのため別々のリージョンにあっても内部IPアドレスで相互通信できます
基本的には、世界の別々の場所にあるVMでも同一ネットワーク上にあれば
Googleのグローバルファイバー網を利用できます
一方、CとDは同じネットワーク上にないため、既定では同じリージョンにあっても外部IPアドレスで相互通信する必要があります
CとDの間のトラフィックは実際には公共のインターネットは経由せずに、Googleエッジルーターで中継されます
この場合の課金とセキュリティの考慮事項については後で説明します
VPCネットワーク内のVMインスタンスは限定公開でグローバルに通信できるため、単一のVPNでオンプレミスネットワークをGoogle Cloudネットワークに安全に接続できます
図のようになります
２つのVMインスタンスは別々のリージョン（us-west1とus-east1）にありますが、相互の通信にはGoogleのプライベートネットワークを利用し、オンプレミスとの通信にはVPNゲートウェイを使用します
そのため費用が削減され、ネットワーク管理が簡素化されます
サブネットは１つのリージョンで機能します
リージョンには複数のゾーンがあるため、サブネットは複数のゾーンを横断できます
このスライドのリージョン１にはゾーンAとゾーンBの２つがあります
これらのゾーンを横断させてサブネットを拡張できます
サブネット１がその例です
サブネットはIPアドレス範囲にすぎないためその範囲内のIPアドレスを使用できます
注意点として、範囲内の最初と２番目のアドレス、.0と.1はネットワーク用、サブネットのゲートウェイ用に予約されています
したがって、使用可能な最初と２番目のアドレス.2と.3が、VMインスタンスに割り当てられます
各サブネットの範囲内では最後から２番目と最後のアドレスも、ブロードキャストアドレスとして予約されています
つまり、各サブネットのプライマリIP範囲には予約済みのIPアドレスが４つあります
さて、この例の２つのVMは別々のゾーンにありますが、同じサブネットIPアドレスを使用して相互に通信します
したがって、別々のゾーンにあっても同じファイアウォールルールを適用できます
サブネットのIPアドレスについてはGoogle Cloud VPCでは、どのサブネットのIPアドレス空間でも、ワークロードのダウンタイムを伴わずに拡張できます
この図のネットワークのようにサブネットマスクを変えることで、サブネット内でより多くのインスタンスを使用できるようになります
そのため必要に応じて柔軟に拡張できますが、注意点もあります
同じVPC内のサブネット間でのマスクの重複はどのリージョンでも許可されません
VPC内のサブネットの各IP範囲は一意の有効なCIDRブロックである必要があります
また、新しいサブネットIPアドレス範囲はリージョン内部IPアドレスであるため、有効なIP範囲内である必要があります
サブネット範囲は、制限付きの範囲と同じ範囲やそれよりも狭いまたは広い範囲にできません
サブネット範囲は、有効なRFC範囲とプライベート用のパブリックIPの範囲にまたがることはできません
また、複数のRFC範囲にまたがることもできません
新しいサブネットの範囲は元の範囲より大きくします
つまり、接頭辞の長さの値を小さくする必要があります
したがって、拡張すると元に戻せません
自動モードのサブネットの場合、IP範囲はデフォルトで/20です
/16まで拡張できますが、それ以上拡張することはできません
代わりに、自動モードのサブネットワークをカスタムモードに変換することで、IP範囲をさらに拡張できます
また、大きなサブネットの作成は避けてください
サブネットが大きすぎると、複数のネットワークインターフェースやVPCネットワークピアリングを使用する場合や、オンプレミスへの接続を構成する場合にCIDR範囲が競合する可能性が高くなります
そのため、サブネットは必要以上に拡張しないでください
