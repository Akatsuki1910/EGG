このラボではCloud IAMのロールの付与と取り消しを、まずはユーザーUsername 2に対して、次にサービス アカウント ユーザーに対して行いました
両方のユーザーを使用することで、行った変更の結果を確認できました
ラボのチュートリアルに進みますが、GCPのUIは変更されることがあるため、環境によっては表示がやや異なります
Cloud IAMラボのチュートリアルへようこそ
このラボでは２人のユーザーが設定されており、この時点ではUsername 1としてコンソールにログインしています
Qwiklabsには、ログイン用のユーザー名が２つあるので、その両方を使って操作を行います
今はUsername 1としてログインしています
そこでまず別のタブで、Username 2としてコンソールにログインします
コンソールを開き、ユーザー名を変えますね
ここで[アカウントを追加]を選択し、Username 2を使用します
両方のユーザー名に同じパスワードが設定されています
ログインしましょう
Qwiklabsでは新しいアカウントを作成すると、必ず新規ユーザーに同意が求められます
利用規約に同意して進みます
タスク２ではIAMコンソールを探索してみましょう
Username 1のタブに移動します
ここから[IAM]をクリックします
[追加]をクリックすると、設定可能なさまざまなロールを確認できます
[キャンセル]をクリックしますあとは自由にご覧ください
さまざまなプロダクトやサービスに基づくロールがあることがわかります
[キャンセル]をクリックします
Username 2に移動しましょう
同じように[IAM]を選択します
まずこのリストから、Username 1に関連付けられた名前を探します
ここでは末尾が82462の名前です
これです
そしてこちらがUsername 2です
それぞれ異なるロールが関連付けられています
Username 1には、App Engine管理者、BigQuery管理者、編集者、オーナー、閲覧者の権限があります
一方このタブでログインしているUsername 2には、閲覧者の権限のみがあります
ではタスク３に進みましょう
Username 1に戻ります
このラボでは何度もタブを切り替えるので、Username 1のタブとUsername 2のタブを間違えないでください
Google Cloud Storageに移動します
ここでバケットを作成します
バケットは、グローバルに一意である必要があるので、私の一意のCloudプロジェクトIDを使用します
[作成]をクリックして、その他はすべてデフォルトのままにします
必ずバケットの名前をメモしておいてください
ラボ全体でバケット名として使用します
ここで[ファイルのアップロード]に進みます
任意のサンプルファイルを探してみましょう
これはただのスクリーンショットですが、これをアップロードします
アップロードしたらここで名前を変更します
ここではsample.txtという名前を付けます
なぜこのような名前を付けるかというと、既存ファイルの長い名前よりも、sample.txtのような名前にした方が、これから行うコマンドの実行がずっと簡単になるからです
この時点で、ラボの[進行状況を確認]ボタンをクリックすると、バケット作成とサンプルファイルのアップロードが正しく行われていれば、緑色のチェックマークと５点が表示されます
ではUsername 2に切り替えて、[Storage]>[ブラウザ]に移動します
Username 2にそのバケットへの閲覧者権限があることを確認します
ありました
権限が継承されているので、サンプルファイルの閲覧が可能です
タスク４ではUsername 2のプロジェクト閲覧者ロールを削除します
それにはまずUsername 1に戻ります
[IAM]に戻ります
Username 2を探します
こちらの73がそうです
[編集]をクリックします
ゴミ箱アイコンをクリックして削除し、[保存]をクリックします
ここでも[進行状況を確認]をクリックして、５点と緑色のチェックマークが表示されることを確認します
正しく操作できていれば、ラボに20点中10点と表示されているはずです
ラボで所定の点数が獲得できない場合は、手順をいくつか見落としている可能性があります
よく変更されるため、ラボが破損していることもありますが、そうでない場合は単に手順を見落としただけという可能性があります
ですから通常は手順を３つほど戻って、これまでの操作を確認して見落としがないか確認することをおすすめします
ほとんどはそれで解決します
では次にUsername 2のアクセス権が取り消されたことを確認します
Username 2のバケットのタブに戻り、[Google Cloud Platform]をクリックします
[Storage]に戻って確認します
または画面を更新することもできます
更新します
バケットのリストを読み込めませんでした
アクセス権がなくなったことがわかります
では次にタスク５として、ストレージへのアクセス権を追加します
Username 2の値を、Qwiklabsのラボ名からコピーします
ラボの手順の左側にある[接続の詳細]でコピーできます
Username 1のタブに戻ります
すでにIAMが表示されているので、[追加]をクリックします
次に新しいメンバー用にここに値を貼り付けます
これです
次に[Storage]を選択します
アルファベット順になっているので、下にスクロールします
[Storageオブジェクト閲覧者]を選択します
[保存]をクリックします
ここがラボのもう１つのポイントです
戻って[進行状況を確認]をクリックして、５点が追加されれば、実際に正しい権限を付与したことがわかります
モジュールで注意したように、権限をアップロードしても、GCP Consoleに直ちに反映されないことがあります
その場合は少しお待ちください
[進行状況を確認]をクリックして、数秒ほど待つと、５点と緑色のチェックマークが表示されます
タスク５では次に、Username 2にストレージへのアクセス権があることを確認します
こちらに戻って、失礼しました
Cloud Shellを起動します
Username 2にはプロジェクト閲覧者ロールがないため、コンソールには何も表示されません
ただしCloud Storageでは表示できるのでここではCloud Shellを使用します
ではバケット名を確認しましょう
先ほどコピーしましたが忘れてしまいました
[Storage]に戻って、ここでバケット名をコピーします
Cloud Shellに戻りgsutil lsを使って、バケットgs://[バケット名]のリストを取得します
Username 2は、バケットにsample.txtがあることを確認できます
ここでUsername 2のタブは閉じてかまいません
ラボの残りは、Username 1のコンソールで行います
タスク６では、サービス アカウント ユーザーを設定します
[IAM]で[サービス アカウント]に移動します
サービス アカウントを作成しましょう
サービス アカウント名はread-bucket-objectsとします
[作成]をクリックします
割り当てるロールを指定するよう求められるので、[Storage]を選択し、[Storageオブジェクト閲覧者]を選択して[続行]をクリックします
そして[完了]をクリックします
これでサービス アカウントを作成できたので、[IAM]のメインページに戻り、作成したサービス アカウントを選択して[追加]をクリックします
メンバーを追加する場合、通常は特定のユーザー、グループ、ドメインに対してこの操作をしますが、トレーニングとしてこの動画では、サービス アカウント ユーザーのロールをAltostrat.comという会社の全員に付与します
これはデモとトレーニングで用いる架空の会社です
したがって新しいメンバーはaltostrat.comとし、[Service Accounts]から、[サービス アカウント ユーザー]を選択して[保存]をクリックします
[IAM]に戻り、[追加]をクリックして、Compute Engineへのアクセス権を付与します
新しいメンバーはaltostrat.comとします
正しく入力してください
[Compute Engine]を選択し、[Compute インスタンス管理者（V1）]を選択して[保存]をクリックします
基本的にこの手順は特定のユーザーに対して行う操作になります
ユーザーにVMインスタンスに対する、制限付きの権限を付与するものです
SSH経由でVMに接続し、いくつかの管理タスクを実行できます
アカウントでVMを作成します
[作成]をクリックします
ここではラボのデモで使用したのと同じ名前のIAMを使います
us-central1を使用します
[ゾーン]はus-central1-cとし、[マシンタイプ]はf1-microとします
デモ用なので無駄なリソースは使いません
サービス アカウントにはread bucket objectsアカウントを選択します
[作成]をクリックします
ここがラボのもう１つのポイントです
[進行状況を確認]をクリックすれば、ラボで最後の５点を獲得したことが確認できるはずです
ここでも反映されるまでに数秒かかることがあります
少し待ってから緑色のチェックマークと、最後の５点をご確認ください
タスク７では、サービス アカウント ユーザーのロールを探索します
ラボのタスクはすべて完了しているので、これは単なる学習目的です
ここでこのアカウントで先ほど作成したVMにSSH接続します
gcloud compute Instances listを実行します
プロジェクトのインスタンスのリストを表示するための適切な権限がないため
エラーが表示されるはずです
少し待ちましょう
エラーが表示されました
一部のリクエストは権限がないので失敗しました
今度は先ほど作成したバケットから、ファイルをコピーするのにgsutilを使用します
バケット名であるプロジェクトIDを忘れてしまったので確認します
[バケット名]/sample.txtです
正常にコピーされたことがわかります
では別のファイルにコピーしてみましょう
自分のバケットにアップロードします
バケット名はここです
ダウンロードできても追加できないことがわかります
まとめるとこのラボではCloud IAMのロールの付与と取り消しを、まずユーザーに対して、次にサービス アカウント ユーザーに対して行いました
チュートリアルがお役に立てば幸いです
ありがとうございました
